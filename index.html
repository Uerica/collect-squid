<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- 要加chartset=utf-8 這樣如果html中有寫中文，傳送時編碼(encoding)才會正常 -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- <link rel="stylesheet" href="css/normalize.css"> -->
    <link rel="stylesheet" href="css/reset.css">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/global.css">
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js'></script>
    <script src="https://kit.fontawesome.com/629062769a.js"></script>
    <script src="js/main.js"></script>
    <title>Document</title>
</head>

<body>
    <header class="common_header">
        <div class="menuMobile">
            <span class="menuMobile_circle"></span>
            <a href="#" class="menuMobile_link">
                <span class="menuMobile_icon">
                    <span class="menuMobile_line menuMobile_line-1"></span>
                    <span class="menuMobile_line menuMobile_line-2"></span>
                    <span class="menuMobile_line menuMobile_line-3"></span>
                </span>
            </a>
        </div>

        <div class="menuMobile_overlay">
            <ul class="memberInfo">
                <li class="coin">
                    <a href="javascript:;">
                        <img src="imgs/icon/coin.png" alt="持有金額icon">
                        <span>1500</span>
                    </a>
                </li>
                <li class="logo">
                    <a href="javascript:;">
                        <img src="imgs/logo.png" alt="尋找友誼網站LOGO">
                        <span>尋找友誼</span>
                    </a>
                </li>
                <li class="login">
                    <img src="imgs/icon/avatar.png" alt="角色頭像icon">
                    <span class="name">
                        <a href="javascript:;">魚翔</a>
                    </span>
                    <span>
                        <a href="javascript:;">登出</a>
                    </span>
                </li>
            </ul>
            <nav class="menuMobile_nav">
                <li><a href="javascript:;"> <img src="imgs/icon/room.png" alt="我的房間icon">
                        <span>我的房間</span></a></li>
                <li><a href="javascript:;"> <img src="imgs/icon/fittingRoom.png" alt="換衣間icon">
                        <span>換衣間</span></a></li>
                <li><a href="javascript:;"> <img src="imgs/icon/friend.png" alt="找朋友icon">
                        <span>找朋友</span></a></li>
                <li><a href="javascript:;"> <img src="imgs/icon/events.png" alt="揪團活動icon">
                        <span>揪團活動</span></a></li>
                <li><a href="javascript:;"> <img src="imgs/icon/mall.png" alt="虛擬商城icon">
                        <span>虛擬商城</span></a></li>
                <li><a href="javascript:;"> <img src="imgs/icon/member.png" alt="會員中心icon">
                        <span>會員中心</span></a></li>
                <li><a href="javascript:;"> <img src="imgs/icon/robot.png" alt="客服機器人_icon">
                        <span>客服機器人</span></a></li>
                <li><a href="javascript:;"> <img src="imgs/icon/notice02.png" alt="通知_icon">
                        <span>通知</span></a></li>
            </nav>
        </div>

        <nav class="menuDesktop">
            <ul>
                <li>
                    <a href="javascript:;">
                        <img src="imgs/icon/room.png" alt="我的房間icon">
                        <span>我的房間</span>
                    </a>
                </li>
                <li><a href="javascript:;">
                        <img src="imgs/icon/fittingRoom.png" alt="換衣間icon">
                        <span>換衣間</span></a>
                </li>
                <li>
                    <a href="javascript:;">
                        <img src="imgs/icon/friend.png" alt="找朋友icon">
                        <span>找朋友</span>
                    </a>
                </li>
                <li>
                    <a href="javascript:;">
                        <img src="imgs/icon/events.png" alt="揪團活動icon">
                        <span>揪團活動</span>
                    </a>
                </li>
                <li class="logo">
                    <a href="javascript:;">
                        <img src="imgs/logo.png" alt="尋找友誼網站LOGO">
                        <span>尋找友誼</span>
                    </a>
                </li>
                <li>
                    <a href="javascript:;">
                        <img src="imgs/icon/mall.png" alt="虛擬商城icon">
                        <span>虛擬商城</span>
                    </a>
                </li>
                <li>
                    <a href="javascript:;">
                        <img src="imgs/icon/member.png" alt="會員中心icon">
                        <span>會員中心</span>
                    </a>
                </li>
                <div class="memberInfo">
                    <li class="login">
                        <img src="imgs/icon/avatar.png" alt="角色頭像icon">
                        <span class="name"><a href="javascript:;">魚翔</a></span>
                        <span><a href="javascript:;">登出</a></span>
                    </li>
                    <li class="coin">
                        <a href="javascript:;">
                            <img src="imgs/icon/coin.png" alt="持有金額icon">
                            <span>1500</span>
                        </a>
                    </li>
                    <li class="level">
                        <a href="javascript:;">
                            <img src="imgs/icon/civilian.png" alt="平民等級icon">
                            <span>平民</span>
                        </a>
                    </li>
                </div>
            </ul>
        </nav>
    </header>

    <!-- 聊天群組(1.聊天室 2.好友列表) -->
    <!-- Rou:vue.js #chat_app -->
    <div class="chatGroup" id="chat_app">
        <i class="fas fa-window-minimize closeBtn"></i>
        <!-- 聊天室 -->
        <!-- 聊天室分成三種訊息 1.官方(messageOfficial) 2.發訊息的人(messageSent) 3.收訊息的人(messageReceived) -->
        <div class="chatRoom">
            <div class="chatRoom_content">

                <!-- Rou:公頻區塊在這裏,如果傳訊息給所有人,並且將訊息印出來 -->
                <ul class="chatRoom_main" v-if="chat_to_all">
                    <!-- 發訊息給... -->
                    <div class="chatRoom_sendTo">公頻</div>

                    <!-- 官方訊息 -->
                    <li class="chatRoom_messageOfficial">
                        <div class="text">
                            <p>在你離線時共有 2 人 造訪你的房間</p>
                        </div>
                    </li>

                    <template v-for="message in messages_to_all()">
                        <!-- 發送訊息者 -->
                        <!-- Rou:檢查收到訊息的userid是不是自己來判斷訊息區塊的樣子,以下userid是自己 -->
                        <!-- Rou:在公頻聊天只有大頭貼沒辦法看到名字,在內容中寫入{{ message.user_id }}可以產生正在講話的人的名字 -->
                        <li class="chatRoom_messageSent" v-if="message.user_id == user_id">
                            <div class="message-sent">
                                <div class="text">
                                    <p>{{ message.chat_msg }}</p>
                                </div>
                                <div class="avatar">
                                    <img src="imgs/icon/member0.png" alt="">{{ message.user_id }}
                                </div>    
                            </div>
                        </li>
                        <!-- 接收訊息者 -->
                        <!-- Rou:檢查收到訊息的userid是不是自己來判斷訊息區塊的樣子,以下userid不是自己 -->
                        <!-- Rou:在公頻聊天只有大頭貼沒辦法看到名字,在內容中寫入{{ message.user_id }}可以產生正在講話的人的名字 -->
                        <li class="chatRoom_messageReceived" v-if="message.user_id != user_id">
                            <div class="message-received">
                                <div class="avatar">
                                    <img src="imgs/icon/member0.png" alt="">{{ message.user_id }}
                                </div>
                                <div class="text">
                                    <p>{{ message.chat_msg }}</p>
                                </div>
                            </div>
                        </li>
                    </template>
                </ul>

                <!-- Rou:密語區塊在這裏,檢查不是公頻訊息,並且傳入誰傳訊息給我,再印出-->
                <ul class="chatRoom_main" v-if="!chat_to_all">
                    <!-- 發訊息給... -->
                    <div class="chatRoom_sendTo">TO: {{chat_to_who}}</div>

                    <template v-for="message in messages_to_someone(chat_to_who)">
                        <!-- 發送訊息者 -->
                        <!-- Rou:如果發訊息的人是我 -->
                        <li class="chatRoom_messageSent" v-if="message.user_id == user_id">
                            <div class="message-sent">
                                <div class="text">
                                    <p>{{ message.chat_msg }}</p>
                                </div>
                                <div class="avatar">
                                    <img src="imgs/icon/member0.png" alt="">
                                </div>
                            </div>
                        </li>
                        <!-- 接收訊息者 -->
                        <!-- Rou:如果發訊息的人不是我本人 -->
                        <li class="chatRoom_messageReceived" v-if="message.user_id != user_id">
                            <div class="message-received">
                                <div class="avatar">
                                    <img src="imgs/icon/member0.png" alt="">
                                </div>
                                <div class="text">
                                    <p>{{ message.chat_msg }}</p>
                                </div>
                            </div>
                        </li>
                    </template>
                </ul>

                <!-- 訊息輸入區 -->
                <div class="chatRoom_submitMessage">
                    <form action="" class="submitContext form">
                        <!-- Rou:在此用v-model產生動態變數 以及增加事件-->
                        <input type="text" class="messageInput" v-model="chat_send_text">
                        <input type="button" value="傳送" class="submit button-submit" v-on:click="chat_send()">
                    </form>
                </div>

                <!-- 選擇頻道 -->
                <!-- Rou:動作後產生class -->
                <div class="chatRoom_switchChannel button_group">
                    <button class="button private" v-bind:class="{ active: !chat_to_all }">私訊</button>
                    <button class="button public" v-bind:class="{ active: chat_to_all }" v-on:click="public_chat()">公開</button>
                </div>
            </div>
        </div>

        <div class="friendList">
            <div class="friendList_content">
                <ul class="friendList_main">
                    <!-- 上線的好友 -->
                    <li class="friendList_onlineFriend">
                        <!-- 好友類型(online, offline, requested) -->
                        <button class="friendList_friendStatus button">在線好友({{online_friends().length}}/{{friends.length}})</button>

                        <!-- 好友01 每個 friendList_friend 是一位好友-->
                        <!-- Rou:將有上線的好友跑一遍,如果有抓到產生此區塊 -->
                        <div class="friendList_friend" v-for="friend in online_friends()">
                            <!-- 好友大頭貼、暱稱 -->
                            <div class="friendInfo">
                                <div class="avatar">
                                    <img src="imgs/tree_04.png" alt="">
                                </div>
                                <!-- 點擊user名字可以產生聊天視窗 -->
                                <div class="friendName" v-on:click="private_chat(friend)">
                                    <p>{{ friend }}</p>
                                </div>
                            </div>

                            ({{ unread_messages_from_someone(friend).length }})

                            <!-- 好友連線狀態、去他房間、更多 -->
                            <div class="friendAction">
                                <div class="connectStatus">
                                    <div class="dot dot-online"></div>
                                </div>

                                <div class="houseVisit">
                                    <a href="javascript:;"><img src="imgs/icon/home.png" alt=""></a>
                                </div>

                                <div class="moreAction">
                                    <a href="javavscript:;">
                                        <div class="dot"></div>
                                        <div class="dot"></div>
                                        <div class="dot"></div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </li>

                    <!-- 離線的好友 -->
                    <li class="friendList_offlineFriend">
                        <button class="friendList_friendStatus button">離線好友({{offline_friends().length}}/{{friends.length}})</button>
                        
                        <!-- Rou:將離線好友跑一遍,如果有抓到產生此區塊 -->
                        <div class="friendList_friend" v-for="friend in offline_friends()">
                            <div class="friendInfo">
                                <div class="avatar">
                                    <img src="imgs/tree_04.png" alt="">
                                </div>
                                <div class="friendName">
                                    <p>{{ friend }}</p>
                                </div>
                            </div>

                            <div class="friendAction">
                                <div class="connectStatus">
                                    <div class="dot dot-offline"></div>
                                </div>

                                <div class="houseVisit">
                                    <a href="javascript:;"><img src="imgs/icon/home.png" alt=""></a>
                                </div>

                                <div class="moreAction">
                                    <a href="javavscript:;">
                                        <div class="dot"></div>
                                        <div class="dot"></div>
                                        <div class="dot"></div>
                                    </a>
                                </div>
                            </div>
                        </div>

                    </li>

                    <!-- 好友邀請中 -->
                    <li class="friendList_requestedFriend">
                        <button class="friendList_friendStatus button">好友邀請中</button>
                        <div class="friendList_friend">
                            <div class="friendInfo">
                                <div class="avatar">
                                    <img src="imgs/tree_04.png" alt="">
                                </div>
                                <div class="friendName">
                                    <p>毛筆</p>
                                </div>
                            </div>

                            <div class="friendAction">
                                <!-- 接受好友申請 -->
                                <div class="requestAccept">
                                    <a href="javascript:;"><img src="imgs/icon/accept.png" alt=""></a>
                                </div>
                                <!-- 拒絕好友申請 -->
                                <div class="requestRefuse">
                                    <a href="javascript:;"><img src="imgs/icon/refuse.png" alt=""></a>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="friendList_open">
        <button class="button friendList_openBtn">開啟聊天室</button>
    </div>
    
    <div class="loginBox">
        <div class="loginContent">
            <div class="intro">
                <div class="logo">
                    <img src="imgs/loginBox/logo.png" alt="Logo" />
                    <h2>收集友誼</h2>
                </div>
                <div class="drawing">
                    <img src="imgs/loginBox/logingBg.png" alt="Login Background" />
                </div>
                <div class="slogan"><p>線上魷魚，即時友誼</p></div>
            </div>

            <div class="loginForm">
                <h3>會員登入</h3>
                <form action="">
                    <div class="personalInfo">
                        <div class="inputField">
                            <label for="memId">暱稱</label>
                            <input type="text" name="memId" id="memId" />
                        </div>
                        <div class="inputField">
                            <label for="memPsw">密碼</label>
                            <input type="text" name="memPsw" id="memPsw" />
                        </div>
                            <a href="javascript:;">忘記密碼？</a>
                    </div>
                    <div class="submitBtns">
                        <input class="createRole" type="submit" value="創角" />
                        <input type="button" value="登入" onclick="login()" />
                        <input class="godMode" type="submit" value="上帝模式" />
                    </div>
                </form>
            </div>
        </div>
    </div>








<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/vue.js"></script>
<script> 
    // Then some JavaScript in the browser:
    var conn_chat;

    var chat_app = new Vue({
        el: '#chat_app',
        data: {
            user_id: '',
            friends: ['董董','曲翑','揉揉','詩詩','華姐'],
            online_users: [],
            chat_to_all: true,
            chat_to_who: '',
            messages: [],//存server回傳的物件
            chat_send_text: ''
        },
        methods:{
            user_online: function(user){
                this.online_users.push(user);
            },
            user_offline: function(user){
                this.online_users = this.online_users.filter(function(e){ return e != user });
            },
            public_chat: function() {
                this.chat_to_who = '';
                this.chat_to_all = true;
            },
            private_chat: function(who) {
                this.chat_to_who = who;
                this.chat_to_all = false;
                this.mark_read_messages_from_someone(who);
            },
            chat_send: function() {
                if(this.chat_to_all == true) {
                    chat_to_all(this.user_id, this.chat_send_text);
                }else{
                    chat_to_someone(this.user_id, this.chat_to_who , this.chat_send_text);
                }
            },
            online_friends: function() {
                // this.friends.filter( function(e){ return this.online_users.includes(e); } );
                return $(this.friends).filter(this.online_users).toArray();//jq 兩個array的交集
            },
            offline_friends: function() {
                // this.friends.filter( function(e){ return !this.online_users.includes(e); } );
                return $(this.friends).not(this.online_users).toArray();//jq 兩個array的差集
            },
            messages_to_all: function(){
                return this.messages.filter(function(msg){ //msg代表messages陣列裡的每一個物件 filter讓接到的物件跑一遍
                    return msg.chat_type == "ALL";
                });
            },
            messages_to_someone: function(who){
                return this.messages.filter(function(msg){
                    return msg.chat_type == "USER" && (msg.user_id == who || msg.chat_to == who);
                });
            },
            unread_messages_from_someone: function(who){
                return this.messages.filter(function(msg){
                    return msg.chat_type == "USER" && msg.user_id == who && msg.is_read == false;
                });
            },
            mark_read_messages_from_someone: function(who){
                this.unread_messages_from_someone(who).forEach(function(msg) { msg.is_read = true} );
            }
        }
    });

    var onMessageListener = function(e) { 
        // 收到server傳過來的訊息
        // console.log(e)裡面好多東西喔~;
        var resp_obj = JSON.parse(e.data); //字串轉json
        // console.log("回傳的JSON物件",resp_obj);
        console.log("收到訊息，訊息類型",resp_obj.msg_type);
        switch(resp_obj.msg_type) {
            case 'CHAT': //聊天的訊息
                console.log('把資料塞到泡泡裡', resp_obj);

                console.log('把資料更新到聊天視窗', resp_obj);
                chat_app.messages.push(resp_obj);
                break;
            case 'ONLINE_USERS':
                console.log('更新目前有哪些人在線上', resp_obj.users);
                chat_app.online_users = resp_obj.users;
                break;
            case 'USER_OFFLINE':
                console.log('把使用者狀態改成下線', resp_obj.user_id);
                chat_app.user_offline(resp_obj.user_id);
                break;
            case 'USER_ONLINE':
                console.log('有人上線了', resp_obj.user_id);
                chat_app.user_online(resp_obj.user_id);
                break;
                
            default:
                console.error('收到不認得的msg_type', resp_obj);
        }
    };

    function initWebsocketServer() {
        conn_chat = new WebSocket('ws://35.229.227.58/chat');
        conn_chat.onopen = function(e) { 
            console.log('已連到伺服器');
        };

        conn_chat.onclose = function(e) { 
            console.log('已close伺服器');
        };
        conn_chat.onmessage = onMessageListener;
    }

    function login() {
        var user_id = $('#memId').val();
        // 告訴server我的user_id
        chat_app.user_id = user_id;
        $('.loginBox').css('display','none');
        conn_chat.send(
            JSON.stringify(
                { "msg_type": "LOGIN", "user_id": user_id }
                )
            );  
            
        conn_chat.send(
            JSON.stringify(
                {
                    "msg_type": "GET_ONLINE_USERS",
                    "user_id": user_id
                }
            )
        )
    }

    function chat_to_someone(user_id, to, msg) {
        conn_chat.send(
            JSON.stringify(
                {
                    "msg_type": "CHAT", 
                    "user_id": user_id, 
                    "chat_type": "USER", 
                    "chat_to": to, 
                    "chat_msg": msg,
                    "is_read": false
                }
                )
            ); 

    }

    function chat_to_all(user_id, msg) {
        conn_chat.send(
            JSON.stringify(
                { 
                    "msg_type": "CHAT", 
                    "user_id": user_id, 
                    "chat_type": "ALL", 
                    "chat_msg": msg
                }
                )
            ); 
    }

    $(document).ready(function(){
        initWebsocketServer();
    });
</script>

</body>

</html>